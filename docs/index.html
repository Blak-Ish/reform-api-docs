<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reform APIs</title>
</head>
<body>
    <ul id="apis"></ul>
    <div id="api" style="width: 1000px;height:800px;"></div>
    <script type="text/javascript">
        function build(data) {
            // populate list
            var apiList = document.getElementById('apis');

            data.forEach(function(el) {
                console.log(el);
                if (el.spec) {
                    apiList.insertAdjacentHTML('beforeend', '<li><a href="./swagger.html?url=' + el.spec + '">' + el.name + '</a></li>');
                } else {
                    apiList.insertAdjacentHTML('beforeend', '<li>' + el.name + '</li>');
                }
            });

            var nodeData = data.map(function(micro) {
                var href = "";
                if (micro.spec) {
                    href = "\"href\": \"./swagger.html?url=" + micro.spec + "\","
                }
                return JSON.parse("{" +
                    "\"data\": {" +
                        "\"id\": \"" + micro.name + "\"," +
                        "\"name\": \"" + micro.name + "\"," +
                        href +
                        "\"weight\": " + (micro.name.length * 20) +
                    "}" +
                "}");
            });
            console.log(nodeData);
            var edgesData = data.map(function(micro) {
                var source = micro.name;
                var dependencies = micro.dependencies || [];
                var edge = dependencies.reduce(function(acc, item) {
                    var tmp = "";
                    if (acc === "") {
                        tmp = acc;
                    } else {
                        tmp = acc + ",";
                    }

                    return tmp + "{\"data\":{\"source\":\"" + source + "\",\"target\":\"" + item.name + "\"}}"
                }, "");

                return JSON.parse("[" + edge + "]");
            });
            var edgesFlatData = [].concat.apply([], edgesData);
            console.log(edgesFlatData);
        }

        // load data
        function loadJSON(file, callback) {   
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', file, true); // Replace 'my_data' with the path to your file
            xobj.onreadystatechange = function () {
                if (xobj.readyState == 4 && xobj.status == "200") {
                // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                callback(xobj.responseText);
                }
            };
            xobj.send(null);  
            }
            
        
        function load() {
            loadJSON("./microservices.json", function(response) {
                var microservices = JSON.parse(response);
                build(microservices);
            });
        }

        load();
  </script>
</body>
</html>
